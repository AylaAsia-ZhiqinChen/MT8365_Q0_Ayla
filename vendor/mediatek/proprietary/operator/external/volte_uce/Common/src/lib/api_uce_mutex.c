#include <pthread.h>
#include "api_uce_mutex.h"

struct cmutex
{
    pthread_mutex_t mutex;
};


/*****************************************************************************
 * FUNCTION
 *  CMUTX_Size
 * DESCRIPTION
 *
 * PARAMETERS
 *  void
 * RETURNS
 *
 *****************************************************************************/
unsigned CMUTX_Size()
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return sizeof(struct cmutex);
}


/*****************************************************************************
 * FUNCTION
 *  CMUTX_Init
 * DESCRIPTION
 *
 * PARAMETERS
 *  o           [?]
 *  name        [?]
 * RETURNS
 *
 *****************************************************************************/
int CMUTX_Init(cmutex_t *o, char *name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    char *notused = name;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    pthread_mutex_init(&o->mutex, NULL);
    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  CMUTX_Dest
 * DESCRIPTION
 *
 * PARAMETERS
 *  o       [?]
 * RETURNS
 *
 *****************************************************************************/
int CMUTX_Dest(cmutex_t *o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    pthread_mutex_destroy(&o->mutex);
    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  CMUTX_Get
 * DESCRIPTION
 *
 * PARAMETERS
 *  o           [?]
 *  wait        [IN]
 * RETURNS
 *
 *****************************************************************************/
int CMUTX_Get(cmutex_t *o, cwait_t wait)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (wait)
    {
        case WAIT_NOWAIT:
            if (pthread_mutex_trylock(&o->mutex))
            {
                return -1;
            }
            break;
        case WAIT_FOREVER:
            pthread_mutex_lock(&o->mutex);
            break;
        default:
            return -1;
    }
    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  CMUTX_Put
 * DESCRIPTION
 *
 * PARAMETERS
 *  o       [?]
 * RETURNS
 *
 *****************************************************************************/
int CMUTX_Put(cmutex_t *o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    pthread_mutex_unlock(&o->mutex);
    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  CMUTX_Ctrl
 * DESCRIPTION
 *
 * PARAMETERS
 *  o       [?]
 * RETURNS
 *
 *****************************************************************************/
int CMUTX_Ctrl(cmutex_t *o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cmutex_t *notused = o;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return 0;
}

#if defined _UNIT_

#include <base/utest.h>


/*****************************************************************************
 * FUNCTION
 *  main
 * DESCRIPTION
 *
 * PARAMETERS
 *  void
 * RETURNS
 *
 *****************************************************************************/
int main(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    UTST_Add(SYSS_UTReset);
    UTST_Run(0);
    return 0;
}

#endif /* defined _UNIT_ */

