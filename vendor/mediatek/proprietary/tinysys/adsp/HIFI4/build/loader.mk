DEPS += $(lastword $(MAKEFILE_LIST))

$(PROCESSOR).LOADER_DIR         := $(PLATFORM_DIR)/loader
$(PROCESSOR).LOADER_LDFILE      := $($(PROCESSOR).LOADER_DIR)/link.ld
$(PROCESSOR).LOADER_INC_DIR     := $($(PROCESSOR).LOADER_DIR)/inc
$(PROCESSOR).LOADER_SRC_DIR     := $($(PROCESSOR).LOADER_DIR)/src
$(PROCESSOR).LOADER_S_FILES     := $($(PROCESSOR).LOADER_SRC_DIR)/loader.S
$(PROCESSOR).LOADER_BIN_BUILT   := $(MY_BUILT_DIR)/$(TINYSYS_LOADER)-$(PROCESSOR).bin
$(PROCESSOR).LOADER_BIN_STEM    := $(basename $($(PROCESSOR).LOADER_BIN_BUILT))
$(PROCESSOR).LOADER_BIN_NH      := $($(PROCESSOR).LOADER_BIN_STEM)-no-mtk-header.bin
$(PROCESSOR).LOADER_ELF         := $($(PROCESSOR).LOADER_BIN_STEM).elf
$(PROCESSOR).LOADER_MAP         := $($(PROCESSOR).LOADER_BIN_STEM).map
$(PROCESSOR).LOADER_IMG_HDR_CFG := $(MY_BUILT_DIR)/img_hdr_$(notdir $($(PROCESSOR).LOADER_BIN_STEM)).cfg
$(PROCESSOR).LOADER_S_OBJS      := $($(PROCESSOR).LOADER_S_FILES:%.S=$(MY_BUILT_DIR)/%.o)
$(PROCESSOR).LOADER_OBJS        := $($(PROCESSOR).LOADER_S_OBJS)
LOADER_CFLAGS                   := $(PROCESSOR_FLAGS) -mlittle-endian -mthumb -lnosys -nostartfiles -x assembler-with-cpp

ALL_SCP_BINS  := $(ALL_SCP_BINS) $($(PROCESSOR).LOADER_BIN_BUILT)

$(PROCESSOR).LOADER_INC_DIR += -I$(MY_BUILT_DIR)/generated/include

###########################################################
## Build targets
###########################################################
$($(PROCESSOR).LOADER_BIN_BUILT): PRIVATE_OBJCOPY := $(OBJCOPY)
$($(PROCESSOR).LOADER_BIN_BUILT): \
  PRIVATE_LOADER_IMG_HDR_CFG := $($(PROCESSOR).LOADER_IMG_HDR_CFG)
$($(PROCESSOR).LOADER_BIN_BUILT): \
  PRIVATE_LOADER_BIN_NH := $($(PROCESSOR).LOADER_BIN_NH)
$($(PROCESSOR).LOADER_BIN_BUILT): \
  $($(PROCESSOR).LOADER_ELF) $($(PROCESSOR).LOADER_IMG_HDR_CFG) \
  $(DEPS)
	@echo '$(TINYSYS_NAME): BIN   $@'
	@mkdir -p $(dir $@)
	$(hide)$(PRIVATE_OBJCOPY) -O binary $< $(PRIVATE_LOADER_BIN_NH)
	$(hide)$(MKIMAGE) $(PRIVATE_LOADER_BIN_NH) $(PRIVATE_LOADER_IMG_HDR_CFG) > $@

$($(PROCESSOR).LOADER_ELF): PRIVATE_CC := $(CC)
$($(PROCESSOR).LOADER_ELF): PRIVATE_LOADER_CFLAGS := $(LOADER_CFLAGS)
$($(PROCESSOR).LOADER_ELF): \
  PRIVATE_LOADER_INC_DIR := $($(PROCESSOR).LOADER_INC_DIR)
$($(PROCESSOR).LOADER_ELF): \
  PRIVATE_LOADER_LDFILE := $($(PROCESSOR).LOADER_LDFILE)
$($(PROCESSOR).LOADER_ELF): \
  PRIVATE_LOADER_MAP := $($(PROCESSOR).LOADER_MAP)
$($(PROCESSOR).LOADER_ELF): \
  $($(PROCESSOR).LOADER_S_FILES) \
  $(wildcard $($(PROCESSOR).LOADER_INC_DIR)/*) \
  $(DEPS)
	@echo '$(TINYSYS_NAME): ELF   $@'
	@mkdir -p $(dir $@)
	$(hide)$(PRIVATE_CC) $(PRIVATE_LOADER_CFLAGS) -I$(PRIVATE_LOADER_INC_DIR) -Wl,-T$(PRIVATE_LOADER_LDFILE) -Wl,-Map=$(PRIVATE_LOADER_MAP) -o $@ $<

$($(PROCESSOR).LOADER_IMG_HDR_CFG): $(DEPS)
	$(call gen-image-header,$(TINYSYS_NAME))
