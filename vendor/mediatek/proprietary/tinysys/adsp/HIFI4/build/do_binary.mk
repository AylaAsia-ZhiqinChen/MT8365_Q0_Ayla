ifeq (1,$(words $($(PROCESSOR).ALL_DOS)))
  $(error $(TINYSYS_DO): There should be 0 or more than 1 DOs for $(PROCESSOR))
endif

DEPS += $(lastword $(MAKEFILE_LIST))

ifeq (yes,$(CFG_DO_ENABLED))
$(PROCESSOR).DO_BUILT_DIR    := $(MY_BUILT_DIR)/dynamic_objects
$(PROCESSOR).DO_STEM         := $(MY_BUILT_DIR)/$(TINYSYS_DO)-$(PROCESSOR)
$(PROCESSOR).DO_BUILT        := $($(PROCESSOR).DO_STEM).do
$(PROCESSOR).DO_BUILT_NH     := $($(PROCESSOR).DO_STEM)-no-mtk-header.do
$(PROCESSOR).DO_IMG_HDR_CFG  := \
  $(MY_BUILT_DIR)/img_hdr_$(basename $(notdir $($(PROCESSOR).DO_BUILT))).cfg
$(PROCESSOR).ALL_DO_FEATURES :=

DO_GENERIC_C_FILES := $(patsubst ./%,%,$(DO_GENERIC_C_FILES))
DO_GENERIC_S_FILES := $(patsubst ./%,%,$(DO_GENERIC_S_FILES))
$(PROCESSOR).DO_GENERIC_BUILT_DIR := $($(PROCESSOR).DO_BUILT_DIR)/generic
$(PROCESSOR).DO_GENERIC_C_OBJS := \
  $(DO_GENERIC_C_FILES:%.c=$($(PROCESSOR).DO_GENERIC_BUILT_DIR)/%.o)
$(PROCESSOR).DO_GENERIC_S_OBJS := \
  $(DO_GENERIC_S_FILES:%.S=$($(PROCESSOR).DO_GENERIC_BUILT_DIR)/%.o)
$(PROCESSOR).DO_GENERIC_OBJS   := \
  $($(PROCESSOR).DO_GENERIC_C_OBJS) $($(PROCESSOR).DO_GENERIC_S_OBJS)

$($(PROCESSOR).DO_GENERIC_OBJS): $($(PROCESSOR).TINYSYS_CONFIG_H)

# Prepare DO config environment and add DO ID in generated header
$(foreach do,$($(PROCESSOR).ALL_DOS), \
  $(eval include $(BUILD_DIR)/do_instance.mk) \
  $(eval $(PROCESSOR).CONFIG_OPTIONS += \
    CFG_DO_$($(PROCESSOR).$(do).DO_ID)=\"$(do)\") \
)

ALL_SCP_BINS := $(ALL_SCP_BINS) $($(PROCESSOR).DO_BUILT)

$($(PROCESSOR).DO_BUILT_NH): PRIVATE_DOS_BUILT := $($(PROCESSOR).ALL_DOS_BUILT)
$($(PROCESSOR).DO_BUILT_NH): $($(PROCESSOR).ALL_DOS_BUILT)
$($(PROCESSOR).DO_BUILT_NH): $(DEPS)
	@echo "$(TINYSYS_DO): DO_NH   $@"
	$(hide)cat $(PRIVATE_DOS_BUILT) > $@

$($(PROCESSOR).DO_IMG_HDR_CFG): $(filter-out %.d,$(MAKEFILE_LIST)) | $(MKIMAGE)
$($(PROCESSOR).DO_IMG_HDR_CFG): $(DEPS)
	$(call gen-image-header,$(TINYSYS_DO))

$($(PROCESSOR).DO_BUILT): PRIVATE_DO_NH := $($(PROCESSOR).DO_BUILT_NH)
$($(PROCESSOR).DO_BUILT): PRIVATE_IMG_HDR_CFG := $($(PROCESSOR).DO_IMG_HDR_CFG)
$($(PROCESSOR).DO_BUILT): \
  $($(PROCESSOR).DO_BUILT_NH) $($(PROCESSOR).DO_IMG_HDR_CFG) | $(MKIMAGE)
$($(PROCESSOR).DO_BUILT): $(DEPS)
	@echo "$(TINYSYS_DO): DO      $@"
	$(hide)$(MKIMAGE) $(PRIVATE_DO_NH) $(PRIVATE_IMG_HDR_CFG) > $@

$($(PROCESSOR).DO_GENERIC_C_OBJS): PRIVATE_CC := $(CC)
$($(PROCESSOR).DO_GENERIC_C_OBJS): PRIVATE_CFLAGS := $(CFLAGS)
$($(PROCESSOR).DO_GENERIC_C_OBJS): PRIVATE_INCLUDES := $(INCLUDES)
$($(PROCESSOR).DO_GENERIC_C_OBJS): $($(PROCESSOR).DO_GENERIC_BUILT_DIR)/%.o: %.c
	$(compile-c-or-s-to-o)

$($(PROCESSOR).DO_GENERIC_S_OBJS): PRIVATE_CC := $(CC)
$($(PROCESSOR).DO_GENERIC_S_OBJS): PRIVATE_CFLAGS := $(CFLAGS)
$($(PROCESSOR).DO_GENERIC_S_OBJS): PRIVATE_INCLUDES := $(INCLUDES)
$($(PROCESSOR).DO_GENERIC_S_OBJS): $($(PROCESSOR).DO_GENERIC_BUILT_DIR)/%.o: %.S
	$(compile-c-or-s-to-o)

$($(PROCESSOR).DO_GENERIC_OBJS): $(DEPS)
-include $(patsubst %.o,%.d,$($(PROCESSOR).DO_GENERIC_OBJS))

endif # CFG_DO_ENABLED is yes
