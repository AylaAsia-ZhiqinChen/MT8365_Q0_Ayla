###########################################################
# TinySys ADSP
###########################################################
LOCAL_PATH := $(call my-dir)
include $(CLEAR_VARS)

MTK_HIFIXDSP_SUPPORT = yes

ifeq (yes,$(MTK_HIFIXDSP_SUPPORT))
TINYSYS_HIFI4DSP := tinysys-hifi4dsp
TINYSYS_HIFI4DSP_CLEAN := clean-$(TINYSYS_HIFI4DSP)

ifeq (yes,$(BUILD_WITH_XTENSA))
HIFI4DSP_BIN := hifi4dsp_load.bin
TINYSYS_HIFI4DSP_TARGET_FILE := $(MTK_TARGET_PROJECT)/$(HIFI4DSP_BIN)
TINYSYS_HIFI4DSP_BUILT_INTERMEDIATES := \
	$(call intermediates-dir-for,ETC,$(TINYSYS_HIFI4DSP))

LOCAL_MODULE := $(TINYSYS_HIFI4DSP)
LOCAL_MODULE_STEM := $(HIFI4DSP_BIN)
LOCAL_MODULE_CLASS := ETC
LOCAL_MULTILIB := 32
LOCAL_MODULE_OWNER := mtk
LOCAL_MODULE_PATH := $(TARGET_OUT_VENDOR)/firmware
include $(BUILD_SYSTEM)/base_rules.mk

TINYSYS_HIFI4DSP_BUILD_CMD := \
	PROJECT=$(MTK_TARGET_PROJECT) \
	O=$(abspath $(TINYSYS_HIFI4DSP_BUILT_INTERMEDIATES)) \
	$(if $(filter showcommands,$(MAKECMDGOALS)),V=1) \
	BUILD_TYPE=$(if $(filter-out user,$(TARGET_BUILD_VARIANT)),debug,release) \
	-C $(LOCAL_PATH)

# Main targets
.PHONY: $(TINYSYS_HIFI4DSP)
.KATI_RESTAT: $(LOCAL_INSTALLED_MODULE)
$(TINYSYS_HIFI4DSP): $(LOCAL_INSTALLED_MODULE)

$(LOCAL_BUILT_MODULE):
	$(MAKE) $(TINYSYS_HIFI4DSP_BUILD_CMD) adsp
	$(ACP) $(TINYSYS_HIFI4DSP_BUILT_INTERMEDIATES)/$(TINYSYS_HIFI4DSP_TARGET_FILE) \
	$(TINYSYS_HIFI4DSP_BUILT_INTERMEDIATES)/

# Clean targets
.PHONY: $(TINYSYS_HIFI4DSP_CLEAN)
$(TINYSYS_HIFI4DSP_CLEAN):: FORCE
	@echo "Clean: $(TINYSYS_HIFI4DSP)"
	$(MAKE) $(TINYSYS_HIFI4DSP_BUILD_CMD) clean

else
#$(TINYSYS_HIFI4DSP): ;
#$(TINYSYS_HIFI4DSP_CLEAN): ;
endif # BUILD_WITH_XTENSA
endif # MTK_HIFIXDSP_SUPPORT
